#!/usr/bin/env bash

# update-secret: Safely edit and re-encrypt sops files
# Usage: update-secret <yaml-file>

set -euo pipefail

# Check arguments
if [ $# -ne 1 ]; then
    echo "Usage: $0 <yaml-file>"
    echo "Example: update-secret loom.yaml"
    exit 1
fi

YAML_FILE="$1"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SOPS_CONFIG="$SCRIPT_DIR/.sops.yaml"
TEMP_FILE=""
TEMP_AGE_KEY=""

# Cleanup function
cleanup() {
    if [ -n "$TEMP_FILE" ] && [ -f "$TEMP_FILE" ]; then
        echo "Cleaning up temporary decrypted file..."
        rm -f "$TEMP_FILE"
    fi
    if [ -n "$TEMP_AGE_KEY" ] && [ -f "$TEMP_AGE_KEY" ]; then
        echo "Cleaning up temporary age key..."
        rm -f "$TEMP_AGE_KEY"
    fi
}

# Set trap for cleanup on exit
trap cleanup EXIT

# Validate input file
if [ ! -f "$YAML_FILE" ]; then
    echo "Error: File '$YAML_FILE' does not exist"
    exit 1
fi

# Check if sops is available
if ! command -v sops >/dev/null 2>&1; then
    echo "Error: sops command not found. Please install sops."
    exit 1
fi

# Use host SSH key converted to age format
if ! command -v ssh-to-age >/dev/null 2>&1; then
    echo "Error: ssh-to-age command not found. Please install ssh-to-age."
    exit 1
fi

echo "Converting SSH host key to age format..."
TEMP_AGE_KEY=$(mktemp)
chmod 600 "$TEMP_AGE_KEY"
if ! sudo ssh-to-age -private-key -i /etc/ssh/ssh_host_ed25519_key 2>&1 | tee "$TEMP_AGE_KEY" >/dev/null; then
    rm -f "$TEMP_AGE_KEY"
    echo "Error: Could not convert SSH host key to age format"
    exit 1
fi

# Verify the key file is not empty
if [ ! -s "$TEMP_AGE_KEY" ]; then
    rm -f "$TEMP_AGE_KEY"
    echo "Error: SSH host key conversion produced empty output"
    exit 1
fi

AGE_KEY_FILE="$TEMP_AGE_KEY"

# Create temporary file for editing
TEMP_FILE=$(mktemp --suffix=.yaml)

echo "Decrypting '$YAML_FILE'..."
if ! SOPS_AGE_KEY_FILE="$AGE_KEY_FILE" sops --config "$SOPS_CONFIG" --decrypt "$YAML_FILE" > "$TEMP_FILE" 2>&1; then
    echo "Error: Failed to decrypt '$YAML_FILE'"
    cat "$TEMP_FILE"
    exit 1
fi


# Edit the decrypted file
EDITOR=${EDITOR:-nano}
echo "Opening editor ($EDITOR) for editing..."
if ! "$EDITOR" "$TEMP_FILE"; then
    echo "Error: Editor exited with non-zero status"
    exit 1
fi

# Check if file was actually modified
if ! [ -f "$TEMP_FILE" ]; then
    echo "Error: Temporary file was deleted or corrupted"
    exit 1
fi

# Validate YAML syntax (if yq is available)
if command -v yq >/dev/null 2>&1; then
    echo "Validating YAML syntax..."
    if ! yq eval '.' "$TEMP_FILE" >/dev/null 2>&1; then
        echo "Error: Invalid YAML syntax in edited file"
        exit 1
    fi
fi

# Copy edited content to original file, then encrypt in-place
# (sops config uses path_regex matching, so must encrypt at original path)
echo "Re-encrypting '$YAML_FILE'..."
cp "$TEMP_FILE" "$YAML_FILE"
if ! SOPS_AGE_KEY_FILE="$AGE_KEY_FILE" sops --config "$SOPS_CONFIG" --encrypt --in-place "$YAML_FILE"; then
    echo "Error: Failed to encrypt the edited file"
    exit 1
fi

# Note: cleanup() function will handle temp file deletion via trap

echo "Successfully updated '$YAML_FILE'"

# Verify the file can still be decrypted
echo "Verifying encryption..."
if SOPS_AGE_KEY_FILE="$AGE_KEY_FILE" sops --config "$SOPS_CONFIG" --decrypt "$YAML_FILE" >/dev/null 2>&1; then
    echo "✓ File successfully encrypted and verified"
else
    echo "⚠ Warning: Encrypted file may be corrupted. Please check manually."
    exit 1
fi
