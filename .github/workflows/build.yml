# Copyright (c) 2025 Geoffrey Huntley <ghuntley@ghuntley.com>. All rights reserved.
# SPDX-License-Identifier: Proprietary

name: "build and publish: loom"

on:
  push:
    branches: [trunk]
  pull_request:
  release:
    types: [created]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-cli:
    name: Build CLI (All Platforms)
    runs-on: namespace-profile-cached-amd64

    steps:
      - name: Checkout repository
        uses: namespacelabs/nscloud-checkout-action@v7

      - name: Set up Nix cache
        run: |
          sudo mkdir -p /cache/nix /nix
          sudo mount --bind /cache/nix /nix
          sudo chown runner /nix

      - name: Setup Nix
        uses: cachix/install-nix-action@9aaadd8b85853f67fcdf488e6a4e9efa94ee96e2

      - name: Setup Cachix
        uses: cachix/cachix-action@ee79db531bfb851a7cf47035057b7cca88d26449
        with:
          name: devenv

      # Build all CLI variants via Nix cross-compilation
      - name: Build loom-cli (Linux x86_64)
        run: nix build .#loom-cli-c2n -o result-cli-linux-x86_64

      - name: Build loom-cli (Linux aarch64)
        run: nix build .#loom-cli-linux-aarch64 -o result-cli-linux-aarch64

      - name: Build loom-cli (Windows x86_64)
        run: nix build .#loom-cli-windows -o result-cli-windows-x86_64

      - name: Build loom-cli (Windows aarch64)
        run: nix build .#loom-cli-windows-aarch64 -o result-cli-windows-aarch64

      - name: Build loom-cli (macOS universal)
        run: nix build .#loom-cli-macos -o result-cli-macos

      - name: Prepare artifacts
        run: |
          mkdir -p out
          
          # Linux x86_64
          cp result-cli-linux-x86_64/bin/loom out/loom-linux-x86_64
          chmod +x out/loom-linux-x86_64
          
          # Linux aarch64
          if [ -d result-cli-linux-aarch64 ]; then
            cp result-cli-linux-aarch64/bin/loom-linux-aarch64 out/loom-linux-aarch64
            chmod +x out/loom-linux-aarch64
          fi
          
          # Windows x86_64
          if [ -d result-cli-windows-x86_64 ]; then
            cp result-cli-windows-x86_64/bin/loom-windows-x86_64.exe out/loom-windows-x86_64.exe
          fi
          
          # Windows aarch64
          if [ -d result-cli-windows-aarch64 ]; then
            cp result-cli-windows-aarch64/bin/loom-windows-aarch64.exe out/loom-windows-aarch64.exe
          fi
          
          # macOS (universal or separate binaries)
          if [ -d result-cli-macos ]; then
            if [ -f result-cli-macos/bin/loom-macos-universal ]; then
              cp result-cli-macos/bin/loom-macos-universal out/loom-macos-universal
              chmod +x out/loom-macos-universal
            fi
            if [ -f result-cli-macos/bin/loom-macos-x86_64 ]; then
              cp result-cli-macos/bin/loom-macos-x86_64 out/loom-macos-x86_64
              chmod +x out/loom-macos-x86_64
            fi
            if [ -f result-cli-macos/bin/loom-macos-aarch64 ]; then
              cp result-cli-macos/bin/loom-macos-aarch64 out/loom-macos-aarch64
              chmod +x out/loom-macos-aarch64
            fi
          fi
          
          echo "=== Built artifacts ==="
          ls -la out/

      - uses: actions/upload-artifact@v4
        with:
          name: cli-all-platforms
          path: out/
          retention-days: 7

  build-server:
    name: Build Server
    runs-on: namespace-profile-cached-amd64

    steps:
      - name: Checkout repository
        uses: namespacelabs/nscloud-checkout-action@v7

      - name: Set up Nix cache
        run: |
          sudo mkdir -p /cache/nix /nix
          sudo mount --bind /cache/nix /nix
          sudo chown runner /nix

      - name: Setup Nix
        uses: cachix/install-nix-action@9aaadd8b85853f67fcdf488e6a4e9efa94ee96e2

      - name: Setup Cachix
        uses: cachix/cachix-action@ee79db531bfb851a7cf47035057b7cca88d26449
        with:
          name: devenv

      - name: Build loom-server (nix)
        run: nix build .#loom-server-c2n -o result-server

      - name: Prepare artifact
        run: |
          mkdir -p out
          cp result-server/bin/loom-server out/loom-server
          chmod +x out/loom-server

      - uses: actions/upload-artifact@v4
        with:
          name: server-linux-x86_64
          path: out/loom-server
          retention-days: 7

  build-and-push-images:
    name: Build & Push Container Images
    runs-on: namespace-profile-cached-amd64
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: namespacelabs/nscloud-checkout-action@v7

      - name: Set up Nix cache
        run: |
          sudo mkdir -p /cache/nix /nix
          sudo mount --bind /cache/nix /nix
          sudo chown runner /nix

      - name: Setup Nix
        uses: cachix/install-nix-action@9aaadd8b85853f67fcdf488e6a4e9efa94ee96e2

      - name: Setup Cachix
        uses: cachix/cachix-action@ee79db531bfb851a7cf47035057b7cca88d26449
        with:
          name: devenv

      - name: Install skopeo
        run: nix profile install nixpkgs#skopeo

      - name: Build weaver image
        run: nix build .#weaver-image -o result-weaver-image

      - name: Build loom-server image
        run: nix build .#loom-server-image -o result-server-image

      - name: Login to GHCR
        if: github.ref == 'refs/heads/trunk' || github.event_name == 'release'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | skopeo login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Push loom-server image
        if: github.ref == 'refs/heads/trunk' || github.event_name == 'release'
        run: |
          # Get short SHA for tagging
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          
          # Push with SHA tag
          skopeo copy \
            docker-archive:result-server-image \
            docker://ghcr.io/${{ github.repository_owner }}/loom-server:${SHORT_SHA}
          
          # Push latest tag on trunk
          if [[ "${{ github.ref }}" == "refs/heads/trunk" ]]; then
            skopeo copy \
              docker-archive:result-server-image \
              docker://ghcr.io/${{ github.repository_owner }}/loom-server:latest
          fi
          
          # Push version tag on release
          if [[ "${{ github.event_name }}" == "release" ]]; then
            skopeo copy \
              docker-archive:result-server-image \
              docker://ghcr.io/${{ github.repository_owner }}/loom-server:${{ github.event.release.tag_name }}
          fi

      - name: Push weaver image
        if: github.ref == 'refs/heads/trunk' || github.event_name == 'release'
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          
          skopeo copy \
            docker-archive:result-weaver-image \
            docker://ghcr.io/${{ github.repository_owner }}/loom-weaver:${SHORT_SHA}
          
          if [[ "${{ github.ref }}" == "refs/heads/trunk" ]]; then
            skopeo copy \
              docker-archive:result-weaver-image \
              docker://ghcr.io/${{ github.repository_owner }}/loom-weaver:latest
          fi
          
          if [[ "${{ github.event_name }}" == "release" ]]; then
            skopeo copy \
              docker-archive:result-weaver-image \
              docker://ghcr.io/${{ github.repository_owner }}/loom-weaver:${{ github.event.release.tag_name }}
          fi

  package:
    name: Package Release Bundle
    needs: [build-cli, build-server]
    runs-on: namespace-profile-cached-amd64

    steps:
      - name: Checkout repository
        uses: namespacelabs/nscloud-checkout-action@v7

      - name: Download server binary
        uses: actions/download-artifact@v4
        with:
          name: server-linux-x86_64
          path: dist

      - name: Download CLI binaries
        uses: actions/download-artifact@v4
        with:
          name: cli-all-platforms
          path: dist/bin

      - name: Set permissions
        run: chmod +x dist/loom-server dist/bin/* || true

      - name: List contents
        run: |
          echo "=== Distribution contents ==="
          ls -laR dist/

      - name: Create tarball
        run: tar czf loom-bundle.tar.gz -C dist .

      - uses: actions/upload-artifact@v4
        with:
          name: loom-bundle
          path: loom-bundle.tar.gz
          retention-days: 30

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            loom-bundle.tar.gz
            dist/bin/*
