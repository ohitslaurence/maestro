<!--
 Copyright (c) 2025 Geoffrey Huntley <ghuntley@ghuntley.com>. All rights reserved.
 SPDX-License-Identifier: Proprietary
-->

# Software Bill of Materials (SBOM) System Specification

**Status:** Active\
**Version:** 1.0\
**Last Updated:** 2024-12-19

---

## 1. Overview

### Purpose

This specification describes how Loom generates and distributes Software Bills of Materials (SBOMs)
to provide transparency about dependencies used in both the CLI and server components.

### Goals

- **Standards compliance**: Generate SPDX and CycloneDX format SBOMs
- **Workspace coverage**: Single SBOM that captures all Rust crates in the workspace
- **Release integration**: Attach SBOMs to GitHub releases
- **Reproducibility**: Deterministic dependency graph via locked `Cargo.lock`
- **Supply chain transparency**: Enable security scanning and compliance audits

---

## 2. SBOM Format and Tool

### 2.1 Tool: `cargo-sbom`

**Rationale:**

- Purpose-built for Cargo workspaces
- Directly emits standards-compliant SPDX and CycloneDX JSON
- Lightweight, single-binary distribution
- Deterministic output given stable dependency graph

**Installation:**

```bash
cargo install cargo-sbom --version 0.10.0
```

Version pinning ensures reproducible output across environments.

### 2.2 Supported Formats

| Format             | SBOM File             | Use Case                                              |
| ------------------ | --------------------- | ----------------------------------------------------- |
| SPDX JSON 2.3      | `loom.spdx.json`      | Default; widely supported (Linux Foundation standard) |
| CycloneDX JSON 1.4 | `loom.cyclonedx.json` | Alternative; good for container/DevOps tooling        |

Both formats are generated by default.

---

## 3. Build System Integration

### 3.1 Makefile Targets

```bash
# Generate SBOM (both SPDX and CycloneDX)
make sbom

# Generate only SPDX format
make sbom-spdx

# Generate only CycloneDX format
make sbom-cyclonedx
```

All SBOMs are written to `target/sbom/`.

### 3.2 Directory Layout

```
loom/
├── target/
│   └── sbom/
│       ├── loom.spdx.json          # SPDX 2.3 format
│       ├── loom.cyclonedx.json     # CycloneDX 1.4 format
│       └── .gitignore              # Don't commit SBOMs
├── Makefile                        # make sbom targets
└── ...
```

### 3.3 Development Workflow

SBOMs are **not** automatically generated during normal development. Developers explicitly run:

```bash
# Local SBOM generation (requires cargo-sbom installed)
make sbom

# Or as part of a release build
make release
```

This avoids friction for developers who don't need SBOMs during iteration.

---

## 4. SBOM Content and Coverage

### 4.1 What's Included

A single workspace-level SBOM covers:

- **All Rust crates** in the workspace (CLI + server + libraries)
- **Direct dependencies**: packages explicitly listed in `Cargo.toml`
- **Transitive dependencies**: packages pulled in by direct dependencies
- **Build-time dependencies**: tools and dev dependencies (captured for completeness)

Example crates included:

- `loom-cli`, `loom-server`, `loom-core`
- `loom-config`, `loom-version`, `loom-thread`
- Upstream: `tokio`, `axum`, `serde`, `clap`, etc.

### 4.2 SPDX Fields

For SPDX JSON 2.3:

```json
{
  "SPDXID": "SPDXRef-DOCUMENT",
  "spdxVersion": "SPDX-2.3",
  "creationInfo": {
    "created": "2024-12-19T10:30:00Z",
    "creators": ["Tool: cargo-sbom-0.10.0"]
  },
  "name": "loom",
  "dataLicense": "CC0-1.0",
  "packages": [
    {
      "SPDXID": "SPDXRef-Package-loom-cli",
      "name": "loom-cli",
      "version": "0.1.0",
      "downloadLocation": "https://github.com/ghuntley/loom",
      "filesAnalyzed": false,
      "licenseConcluded": "NOASSERTION"
    },
    ...
  ]
}
```

### 4.3 CycloneDX Fields

For CycloneDX JSON 1.4:

```json
{
  "bomFormat": "CycloneDX",
  "specVersion": "1.4",
  "version": 1,
  "metadata": {
    "timestamp": "2024-12-19T10:30:00Z",
    "tools": [
      {
        "vendor": "cargo-sbom",
        "name": "cargo-sbom",
        "version": "0.10.0"
      }
    ]
  },
  "components": [
    {
      "bom-ref": "pkg:cargo/loom-cli@0.1.0",
      "type": "library",
      "name": "loom-cli",
      "version": "0.1.0",
      "purl": "pkg:cargo/loom-cli@0.1.0"
    },
    ...
  ]
}
```

---

## 5. Reproducibility and Stability

### 5.1 Deterministic Elements

The following elements are fully reproducible across rebuilds on the same commit:

- **Dependency graph**: Identical given `Cargo.lock`
- **Package names, versions, and licenses**: Fixed by `Cargo.lock`
- **SBOM structure**: Deterministic given stable tool version

### 5.2 Non-Deterministic Elements

These fields vary between runs (expected and acceptable):

- `creationInfo.created` (timestamp)
- `metadata.timestamp` (timestamp)
- UUID-based namespaces (e.g., `SPDXRef-DOCUMENT`)

**Mitigation:**

- For strict reproducibility, post-process SBOMs to normalize or remove timestamps
- For practical purposes, the **dependency graph is what matters** for security audits

### 5.3 Ensuring Reproducibility

1. **Lock the dependency graph**
   - Commit `Cargo.lock` to version control (already done)
   - Build with `cargo build --locked` in CI

2. **Pin the tool version**
   - Always install `cargo-sbom@0.10.0` (pinned in CI)
   - Document version requirement in `CONTRIBUTING.md`

3. **Stable environment**
   - Run SBOM generation on consistent runners (e.g., `ubuntu-latest`)

---

## 6. CI/CD Integration

### 6.1 GitHub Actions Workflow

Add a step to your release workflow:

```yaml
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build (workspace)
        run: cargo build --workspace --locked

      - name: Install cargo-sbom
        uses: psastras/sbom-rs/actions/install-cargo-sbom@cargo-sbom-v0.10.0

      - name: Generate SBOM
        run: make sbom

      - name: Upload SBOM as artifact
        uses: actions/upload-artifact@v4
        with:
          name: loom-sbom
          path: target/sbom/*

      # Optional: attach to GitHub Release
      - name: Upload SBOM to release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${GITHUB_REF##*/}" target/sbom/* --clobber
```

### 6.2 Artifact Retention

- **SBOM artifacts**: 30 days (build artifacts)
- **Release SBOMs**: Indefinite (attached to releases)

---

## 7. Usage Scenarios

### 7.1 Security Audit

Download SPDX SBOM and scan with `syft` or `grype`:

```bash
grype sbom:loom.spdx.json  # Find vulnerabilities
```

### 7.2 License Compliance

Extract and audit licenses in SPDX format:

```bash
# Parse SPDX JSON to list all packages and licenses
jq '.packages[] | {name, version, licenseConcluded}' loom.spdx.json
```

### 7.3 Dependency Drift Detection

Compare SBOMs across versions:

```bash
diff <(jq '.packages | sort' loom-v0.1.0.spdx.json) \
     <(jq '.packages | sort' loom-v0.2.0.spdx.json)
```

### 7.4 Container Image SBOM

If you later build Docker images, generate image-level SBOMs with `syft`:

```bash
syft packages oci:loom:latest -o spdx-json > loom-image.spdx.json
```

Then attach **both** the source SBOM and image SBOM to releases.

---

## 8. Best Practices

### 8.1 Local Development

1. Install `cargo-sbom` locally:
   ```bash
   cargo install cargo-sbom --version 0.10.0
   ```

2. Generate SBOMs before release:
   ```bash
   make sbom
   ```

3. Commit generated SBOMs to release branch for signing (optional):
   ```bash
   git add target/sbom/loom.spdx.json target/sbom/loom.cyclonedx.json
   git commit -m "chore: add SBOMs for v0.2.0"
   ```

   Or rely on CI to generate them automatically.

### 8.2 Release Checklist

- [ ] Build and test all platforms
- [ ] Run `make sbom` or let CI generate
- [ ] Verify SBOM format with schema validator
- [ ] Attach SBOMs to GitHub Release
- [ ] Document SBOM location in release notes

### 8.3 Documentation

Include in `README.md` or release notes:

```markdown
## Software Bill of Materials (SBOM)

This release includes Software Bill of Materials in standard formats:

- **[loom.spdx.json](...)** - SPDX 2.3 JSON (Linux Foundation standard)
- **[loom.cyclonedx.json](...)** - CycloneDX 1.4 JSON

Use these to audit dependencies, check for vulnerabilities, or verify license compliance.
```

---

## 9. Future Enhancements

### 9.1 SBOM Signing

Sign SBOMs with a release signing key to verify authenticity:

```bash
gpg --sign target/sbom/loom.spdx.json
```

### 9.2 Build-time Vulnerability Scanning

Integrate vulnerability scanning into CI:

```bash
cargo install cargo-audit
cargo audit
```

or with SBOMs:

```bash
grype sbom:target/sbom/loom.spdx.json
```

### 9.3 Multi-Level SBOMs

Generate separate SBOMs for:

- **Workspace-level** (current): all crates
- **Binary-level** (future): specific binaries (loom-cli vs loom-server)
- **Image-level** (future): container images with OS packages

### 9.4 Custom Fields

Add custom SBOM fields for:

- Support contact (email, URL)
- Security policy reference
- Build reproducibility info

---

## 10. Troubleshooting

### cargo-sbom not found

**Error:** `command not found: cargo-sbom`

**Solution:**

```bash
cargo install cargo-sbom --version 0.10.0
# or with cargo-binstall (faster):
cargo binstall cargo-sbom@0.10.0
```

### SBOM generation is slow

**Cause:** First run rebuilds metadata\
**Solution:** Subsequent runs are cached; or use `cargo clean` and rebuild if needed

### SBOM format validation fails

**Check:**

```bash
# Validate against SPDX schema (requires jq + schema file)
jq . target/sbom/loom.spdx.json > /dev/null && echo "Valid JSON"
```

**Validate with online tools:**

- SPDX validator: https://tools.spdx.org/
- CycloneDX validator: https://cyclonedx.org/validator/

---

## 11. References

- [SPDX Specification](https://spdx.github.io/spdx-spec/)
- [CycloneDX Format](https://cyclonedx.org/)
- [cargo-sbom on GitHub](https://github.com/psastras/sbom-rs)
- [NTIA SBOM Minimum Elements](https://ntia.gov/files/ntia/publications/ntia_sbom_minimum_elements_report.pdf)
